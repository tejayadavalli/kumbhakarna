<html>
<head>
    <style type="text/css">
    .multiselect {
    width:20em;
    height:3em;
    border:solid 1px #c0c0c0;
    overflow:auto;
}

.multiselect label {
    display:block;
}

.multiselect-on {
    color:#ffffff;
    background-color:#000099;
}
  </style>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap DatePicker</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
    <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css">

</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-sm-4">
            <label for="datepicker1">Start Date</label>
            <input id="datepicker1"  autocomplete="off"/>
            <br/>
        </div>
        <div class="col-sm-4">
            <label for="datepicker2">End Date</label>
            <input id="datepicker2" autocomplete="off"/>
        </div>
        <div class="col-sm-4">
            <strong>Select Language:</strong>
            <select id="multiple-checkboxes" multiple="multiple">
                <option value="s5amTo6am">5amTo6am</option>
                <option value="s6amTo7am">6amTo7am</option>
                <option value="s7amTo8am">7amTo8am</option>
                <option value="s8amTo9am">8amTo9am</option>
                <option value="s9amTo10am">9amTo10am</option>
                <option value="s10amTo11am">10amTo11am</option>
                <option value="s11amTo12pm">11amTo12pm</option>
                <option value="s12pmTo1pm">12pmTo1pm</option>
                <option value="s1pmTo2pm">1pmTo2pm</option>
                <option value="s2pmTo3pm">2pmTo3pm</option>
                <option value="s3pmTo4pm">3pmTo4pm</option>
                <option value="s4pmTo5pm">4pmTo5pm</option>
                <option value="s5pmTo6pm">5pmTo6pm</option>
                <option value="s6pmTo7pm">6pmTo7pm</option>
                <option value="s7pmTo8pm">7pmTo8pm</option>
                <option value="s8pmTo9pm">8pmTo9pm</option>
                <option value="s9pmTo10pm">9pmTo10pm</option>
                <option value="s10pmTo11pm">10pmTo11pm</option>
            </select>
        </div>

    </div>
</div>
<div class="row">
    <div class="col-sm-4">
    </div>
    <div class="col-sm-4">
        <button type="button"  class="btn btn-success btn-block right" onclick="fetchSummary()" width = "200px">Summary</button>
    </div>

    </div>
<div class="row" id="expensesContent">

</div>
<div class="row" id="summaryContent">

</div>


</div>
<script>
        $('#datepicker1').datepicker({
            uiLibrary: 'bootstrap'
        });
        $('#datepicker2').datepicker({
            uiLibrary: 'bootstrap'
        });
    var selection = [];
    $(document).ready(function() {
        $('#multiple-checkboxes').multiselect({
          includeSelectAllOption: true,
          allSelectedText: 'All' ,
          onChange: function(element, checked) {
            var brands = $('#multiple-checkboxes option:selected');
            $(brands).each(function(index, brand){
                selection.push(brand);
            });
        }
        });
    });


    var summaryData;

    function showSlotSummary(){
        $("#summaryContent").html(makeSlotTableHTML(summaryData));
    }

    function showDaySummary(){
        $("#summaryContent").html(makeDayTableHTML(summaryData));
    }

    function fetchSummary(){
      var dateParts1 = $("#datepicker1").val().split("/");
      var startDate = dateParts1[2] + "-" + dateParts1[0] + "-" + dateParts1[1];
      var dateParts2 = $("#datepicker2").val().split("/");
      var endDate = dateParts2[2] + "-" + dateParts2[0] + "-" + dateParts2[1];
      var selectedSlots  = $("#multiple-checkboxes").val();
      var data = {};
      data["startDate"] = startDate;
      data["endDate"] = endDate;
      data["slotsSelected"] = selectedSlots;

       $.ajax({
               url: '/summary',
               type: 'post',
               dataType: "json",
               contentType:"application/json; charset=utf-8",
               success: function(data){
                  summaryData = data["slotSummaries"];
                  expensesData = data["expenseEntries"];
                  $("#summaryContent").html(makeDayTableHTML(summaryData));
                  $("#expensesContent").html(makeExpensesHTML(expensesData));

               },
               error: function (xhr, ajaxOptions, thrownError) {
                 $("#successIndicator").text(thrownError);
               },
               data: JSON.stringify(data)
           });
    }

      function makeExpensesHTML(expensesData) {
            var result =         "<div class = \"row\"><br/><div><h4 style=\"text-align:center;\">Expenses </h4></div> <table class=\"table table-striped\" style = \"margin-left: auto;margin-right: auto;width:70%;\"> <thead>\n" +
                "    <tr>\n" +
                "      <th scope=\"col\">Date</th>\n" +
                "      <th scope=\"col\">Info</th>\n" +
                "      <th scope=\"col\">Expense</th>\n" +
                "    </tr>\n" +
                "  </thead>\n" +
                "  <tbody>";
            var totalExpense = 0;
            for(var i=0; i<expensesData.length; i++) {
                result += "<tr>";
                result += "<td style =\"word-break:break-all;\">"+expensesData[i]["date"] +"</td>";
                result += "<td style =\"word-break:break-all;\">"+expensesData[i]["info"] +"</td>";
                result += "<td style =\"word-break:break-all;\">"+expensesData[i]["expense"] +"</td>";
                result += "<td style =\"word-break:break-all;\">";
                result += "</tr>";
                totalExpense = totalExpense + parseInt(expensesData[i]["expense"]);
            }
                result += "<tr>";
                result += "<td>" + "</td>";
                result += "<td> <b>Total </b>" +"</td>";
                result += "<td>" + totalExpense + "</td>";
                result += "</tr>";
                return result;
      }


      function makeSlotTableHTML(slotSummaries) {
            var result =         "<br/> <hr> <br/><div class = \"row\"><h4 style=\"text-align:center;\">Slot Summary </h4><div class=\"col-sm-3\"></div><div class=\"col-sm-3\"> <button type=\"button\"  class=\"btn btn-warning btn-block right\" onclick=\"showDaySummary()\" width = \"100px\">Day Wise Summary</button></div> </div> <br/> <div class = \"row\"> <table class=\"table table-striped\" style = \"margin-left: auto;margin-right: auto;width:70%;\"> <thead>\n" +
                "    <tr>\n" +
                "      <th scope=\"col\">Date</th>\n" +
                "      <th scope=\"col\">Slot</th>\n" +
                "      <th scope=\"col\">Court</th>\n" +
                "      <th scope=\"col\">Revenue</th>\n" +
                "      <th scope=\"col\">Remark</th>\n" +
                "      <th scope=\"col\">Mode</th>\n" +
                "    </tr>\n" +
                "  </thead>\n" +
                "  <tbody>";
            var totalRevenue = 0;
            for(var i=0; i<slotSummaries.length; i++) {
                result += "<tr>";
                result += "<td style =\"word-break:break-all;\">"+slotSummaries[i]["date"] +"</td>";
                result += "<td style =\"word-break:break-all;\">"+slotSummaries[i]["timing"] +"</td>";
                result += "<td style =\"word-break:break-all;\">"+slotSummaries[i]["court"] +"</td>";
                result += "<td style =\"word-break:break-all;\">"+slotSummaries[i]["revenue"] +"</td>";
                result += "<td style =\"word-break:break-all;\">"+slotSummaries[i]["remark"] +"</td>";
                result += "<td style =\"word-break:break-all;\">"+
                Object.keys(slotSummaries[i]["paymentModes"]).map(data => [data, slotSummaries[i]["paymentModes"][data]]).map(([k, v]) => `${k}:${v}`).join(', ');
                 +"</td>";
                result += "</tr>";
                totalRevenue = totalRevenue + parseInt(slotSummaries[i]["revenue"]);
                }
                result += "<tr>";
                result += "<td>" + "</td>";
                result += "<td>" + "</td>";
                result += "<td> <b>Total </b>" +"</td>";
                result += "<td>" + totalRevenue + "</td>";
                result += "<td>" + "</td>";
                result += "<td>" + "</td>";
                result += "</tr>";

            result += "</tbody></table></div>";
            return result;
         }


      function makeDayTableHTML(slotSummaries) {
            var result =         "<br/> <hr> <br/><div class = \"row\"> <h4 style=\"text-align:center;\">Day Wise Summary </h4> <div class=\"col-sm-3\"></div><div class=\"col-sm-3\"> <button type=\"button\"  class=\"btn btn-warning btn-block right\" onclick=\"showSlotSummary()\" width = \"100px\">Slot Wise Summary</button></div> </div> <br/> <div class = \"row\"> <table class=\"table table-striped\" style = \"margin-left: auto;margin-right: auto;width:70%;\"> <thead>\n" +
                "    <tr>\n" +
                "      <th scope=\"col\">Date</th>\n" +
                "      <th scope=\"col\">Playo</th>\n" +
                "      <th scope=\"col\">UPI</th>\n" +
                "      <th scope=\"col\">Cash</th>\n" +
                "      <th scope=\"col\">Total</th>\n" +
                "    </tr>\n" +
                "  </thead>\n" +
                "  <tbody>";
            var totalRevenue = 0;
            var date = (slotSummaries.length != 0) ? slotSummaries[0]["date"] : "";
            var cashTotal = 0;
            var upiTotal = 0;
            var playoTotal = 0;
            var membershipTotal = 0;
            var selectedCashSummary = 0;
            var selectedUpiSummary = 0;
            var selectedPlayoSummary = 0;
            var selectedMembershipSummary = 0;

            for(var i=0; i<slotSummaries.length; i++) {
                var revenueHere = parseInt(slotSummaries[i]["revenue"]);
                totalRevenue = totalRevenue +  revenueHere;
                if(slotSummaries[i]["date"] === date){
                    paymentModes = slotSummaries[i]["paymentModes"];
                    cashTotal = cashTotal + parseInt(paymentModes["Cash"] !=  undefined ? paymentModes["Cash"] : 0);
                    upiTotal = upiTotal + parseInt(paymentModes["UPI"] !=  undefined ? paymentModes["UPI"] : 0);
                    playoTotal = playoTotal + parseInt(paymentModes["Playo"] !=  undefined ? paymentModes["Playo"] : 0);
                 } else {
                 var dayTotal = parseInt(membershipTotal) + parseInt(playoTotal) + parseInt(upiTotal) + parseInt(cashTotal) ;
                result += "<tr>";
                result += "<td style =\"word-break:break-all;\">"+ date +"</td>";
                result += "<td style =\"word-break:break-all;\">"+playoTotal +"</td>";
                result += "<td style =\"word-break:break-all;\">"+upiTotal +"</td>";
                result += "<td style =\"word-break:break-all;\">"+cashTotal +"</td>";
                result += "<td style =\"word-break:break-all;\">"+ dayTotal +"</td>";
                result += "</tr>";

                date = (slotSummaries.length != 0) ? slotSummaries[i]["date"] : "";
                selectedCashSummary = selectedCashSummary + cashTotal;
                selectedUpiSummary = selectedUpiSummary + upiTotal;
                selectedPlayoSummary = selectedPlayoSummary + playoTotal;
                selectedMembershipSummary = selectedMembershipSummary + membershipTotal;

                cashTotal = 0;
                upiTotal = 0;
                playoTotal = 0;
                membershipTotal = 0;
                paymentModes = slotSummaries[i]["paymentModes"];
                cashTotal = cashTotal + parseInt(paymentModes["Cash"] !=  undefined ? paymentModes["Cash"] : 0);
                upiTotal = upiTotal + parseInt(paymentModes["UPI"] !=  undefined ? paymentModes["UPI"] : 0);
                playoTotal = playoTotal + parseInt(paymentModes["Playo"] !=  undefined ? paymentModes["Playo"] : 0);
                }
                }
                selectedCashSummary = selectedCashSummary + cashTotal;
                selectedUpiSummary = selectedUpiSummary + upiTotal;
                selectedPlayoSummary = selectedPlayoSummary + playoTotal;
                selectedMembershipSummary = selectedMembershipSummary + membershipTotal;
                var dayTotal = parseInt(membershipTotal) + parseInt(playoTotal) + parseInt(upiTotal) + parseInt(cashTotal) ;
                result += "<tr>";
                result += "<td style =\"word-break:break-all;\">"+ date +"</td>";
                result += "<td style =\"word-break:break-all;\">"+playoTotal +"</td>";
                result += "<td style =\"word-break:break-all;\">"+upiTotal +"</td>";
                result += "<td style =\"word-break:break-all;\">"+cashTotal +"</td>";
                result += "<td style =\"word-break:break-all;\">"+ dayTotal +"</td>";
                result += "</tr>";
                result += "<tr>";
                result += "<td> Total: " + "</td>";
                result += "<td>" +selectedPlayoSummary +  " -> " + parseInt(Math.round(100 *(selectedPlayoSummary * 0.9216))/100) + "</td>";
                result += "<td>" +selectedUpiSummary  + "</td>";
                result += "<td>" + selectedCashSummary +"</td>";
                result += "<td>" + ((parseInt(Math.round(100 *(selectedPlayoSummary * 0.9216))/100)) + selectedUpiSummary + selectedCashSummary) + "</td>";
                result += "</tr>";

            result += "</tbody></table></div>";
            return result;
         }
    </script>
</body>
</html>